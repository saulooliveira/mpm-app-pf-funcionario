<!DOCTYPE html>
<html lang="pt-BR">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="description" content="Aplicativo de escalas e feriados para funcion√°rios" />
  <meta name="theme-color" content="#6c7cff" />
  <title>Escalas & Feriados ‚Ä¢ Folgas</title>
  <link rel="manifest" href="./manifest.webmanifest" />
  <link rel="stylesheet" href="./css/styles.css">
</head>

<body>
  <header id="mainHeader" class="minimizable">
    <div class="header-top">
      <div class="brand">
        <div class="logo">EF</div>
        <div>
          <div style="font-weight:700">Escalas & Feriados</div>
          <div style="font-size:.85rem;color:#9aa3b2">Folgas ‚Ä¢ Trocas ‚Ä¢ Calend√°rio</div>
        </div>
        <button class="btn header-toggle" id="toggleHeaderBtn" aria-label="Minimizar header">
          <svg id="headerToggleIcon" width="22" height="22" viewBox="0 0 22 22" fill="none"
            xmlns="http://www.w3.org/2000/svg" style="vertical-align:middle">
            <path id="headerToggleIconPath" d="M6 13l5-5 5 5" stroke="#4f6cff" stroke-width="2.2" stroke-linecap="round"
              stroke-linejoin="round" />
          </svg>
        </button>
      </div>
    </div>
    <div class="controls" id="headerControls">
      <button class="btn" id="prevBtn">‚óÄ</button>
      <div id="currentLabel" class="kbd"></div>
      <button class="btn" id="nextBtn">‚ñ∂</button>

      <div class="btn-group" role="tablist" aria-label="Mudar visualiza√ß√£o">
        <button class="btn-tab active" data-view="month">Mensal</button>
        <button class="btn-tab" data-view="week">Semanal</button>
        <button class="btn-tab" data-view="day">Di√°ria</button>
      </div>

      <select id="employeeSelect" title="Selecionar funcion√°rio"></select>
      <button class="btn ghost" id="todayBtn">Hoje</button>


  <button class="btn adminOnly" id="editScaleModeBtn">üõ†Ô∏è Editar Escala</button>
  <button class="btn adminOnly" id="syncAllBtn">üì° Sincronizar feriados</button>
  <button class="btn adminOnly" id="openSettings">‚öôÔ∏è Configurar APIs</button>
  <button class="btn adminOnly" id="manageUsersBtn">üë§ Usu√°rios</button>
  <!-- Modal de edi√ß√£o de escala -->
  <div id="editScaleModal" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,.35);align-items:center;justify-content:center;z-index:400;">
    <div class="panel" style="width:min(340px,92vw);max-width:96vw;max-height:90vh;overflow:auto;box-shadow:0 8px 32px #0002">
      <div class="split" style="justify-content:space-between">
        <h3 style="margin:0;font-size:1.1rem">Editar Escala</h3>
        <button class="btn" id="closeEditScaleBtn">‚úñ</button>
      </div>
      <div id="editScaleDate" class="muted" style="margin-bottom:.7rem"></div>
      <form id="editScaleForm"></form>
      <div class="split" style="justify-content:flex-end;margin-top:1rem">
        <button class="btn primary" id="saveEditScaleBtn" type="submit">Salvar</button>
      </div>
    </div>
  </div>
  <script>
    // Modo edi√ß√£o de escala para admin
    let editScaleMode = false;
    const editScaleModeBtn = document.getElementById('editScaleModeBtn');
    const editScaleModal = document.getElementById('editScaleModal');
    const closeEditScaleBtn = document.getElementById('closeEditScaleBtn');
    const editScaleForm = document.getElementById('editScaleForm');
    const editScaleDate = document.getElementById('editScaleDate');
    const saveEditScaleBtn = document.getElementById('saveEditScaleBtn');
    let editScaleCurrentDate = null;

    if(editScaleModeBtn) {
      editScaleModeBtn.onclick = () => {
        editScaleMode = !editScaleMode;
        editScaleModeBtn.classList.toggle('primary', editScaleMode);
        editScaleModeBtn.textContent = editScaleMode ? 'üõ†Ô∏è Modo edi√ß√£o ATIVO' : 'üõ†Ô∏è Editar Escala';
      };
    }
    if(closeEditScaleBtn && editScaleModal) {
      closeEditScaleBtn.onclick = () => { editScaleModal.style.display = 'none'; };
    }
    // Intercepta clique nas c√©lulas do calend√°rio
    document.addEventListener('click', function(e) {
      if(!editScaleMode) return;
      const cell = e.target.closest('.cal-cell');
      if(cell && cell.dataset.date) {
        e.preventDefault();
        editScaleCurrentDate = cell.dataset.date;
        editScaleDate.textContent = 'Data: ' + cell.dataset.date.split('-').reverse().join('/');
        // Buscar funcion√°rios e status
        const employees = window.DATA && window.DATA.employees ? window.DATA.employees : [];
        const schedules = window.DATA && window.DATA.schedules ? window.DATA.schedules : {};
        const dayInfo = schedules[editScaleCurrentDate] || { assignments: {} };
        editScaleForm.innerHTML = employees.map(emp => {
          const checked = dayInfo.assignments && dayInfo.assignments[emp] !== 'folga';
          return `<label style="display:flex;align-items:center;gap:.7rem;margin-bottom:.5rem"><span style="flex:1">${emp}</span><input type="checkbox" name="${emp}" ${checked ? 'checked' : ''} style="width:32px;height:32px;accent-color:#4f6cff"></label>`;
        }).join('');
        editScaleModal.style.display = 'flex';
      }
    });
    // Salvar escala editada
    if(editScaleForm && saveEditScaleBtn) {
      saveEditScaleBtn.onclick = function(ev) {
        ev.preventDefault();
        if(!editScaleCurrentDate) return;
        const formData = new FormData(editScaleForm);
        const employees = window.DATA && window.DATA.employees ? window.DATA.employees : [];
        if(!window.DATA.schedules) window.DATA.schedules = {};
        if(!window.DATA.schedules[editScaleCurrentDate]) window.DATA.schedules[editScaleCurrentDate] = { assignments: {} };
        employees.forEach(emp => {
          window.DATA.schedules[editScaleCurrentDate].assignments[emp] = formData.has(emp) ? 'trabalho' : 'folga';
        });
        editScaleModal.style.display = 'none';
        if(window.renderCalendar) window.renderCalendar();
        if(window.renderTeamView) window.renderTeamView();
      };
    }
    // Fecha modal ao clicar fora
    if(editScaleModal) {
      editScaleModal.onclick = e => { if(e.target === editScaleModal) editScaleModal.style.display = 'none'; };
    }
  </script>

      <span class="kbd" id="sessionBadge">‚Äî</span>
      <!-- Bot√£o Legenda -->
      <button class="btn" id="openLegendBtn" style="margin:1rem 0 .5rem 0;max-width:160px">Legenda</button>

      <button class="btn" id="logoutBtn">Sair</button>
    </div>
  </header>

  <main>

    <!-- Modal Legenda -->
    <div id="legendModal"
      style="display:none;position:fixed;inset:0;background:rgba(0,0,0,.35);align-items:center;justify-content:center;z-index:300;">
      <div class="panel"
        style="width:min(340px,92vw);max-width:96vw;max-height:90vh;overflow:auto;box-shadow:0 8px 32px #0002">
        <div class="split" style="justify-content:space-between">
          <h3 style="margin:0;font-size:1.1rem">Legenda</h3>
          <button class="btn" id="closeLegendBtn">‚úñ</button>
        </div>
        <div class="split" style="flex-wrap:wrap;gap:.5rem 1.2rem;margin-top:.7rem">
          <span class="badge work">T</span> <span class="muted">Trabalho</span>
          <span class="badge off">F</span> <span class="muted">Folga</span>
          <span class="badge holiday">FN</span> <span class="muted">Feriado Nacional</span>
          <span class="badge holiday">FM</span> <span class="muted">Feriado Municipal</span>
          <span class="badge work">TF</span> <span class="muted">Trabalho/Folga</span>
        </div>
      </div>
    </div>
    <section class="calendar" aria-label="Calend√°rio">
      <div class="cal-header split">
        <div class="split">
          <span class="label">Data selecionada:</span>
          <span id="selectedDateLabel" class="pill">‚Äî</span>
        </div>
        <div class="split">
          <button class="btn adminOnly" id="toggleHolidayBtn">‚õ±Ô∏è Marcar/Desmarcar Feriado</button>
          <button class="btn adminOnly" id="editScaleBtn">üë• Editar escala</button>
          <button class="btn primary" id="swapBtn">üîÑ Solicitar troca</button>
        </div>
      </div>
      <div id="calendarBody"></div>
    </section>

    <div class="side">
      <section class="panel">
        <h3>Vis√£o Equipe</h3>
        <div class="split" style="margin-bottom:.6rem">
          <div class="split">
            <div class="label">Data base</div>
            <input type="date" id="teamDate">
          </div>
          <div class="btn-group" style="margin-left:.4rem">
            <button class="btn-tab active" data-team="day">Dia</button>
            <button class="btn-tab" data-team="week">Semana</button>
          </div>
          <div class="right muted" id="teamMeta"></div>
        </div>
        <div style="overflow:auto;max-height:420px;border:1px solid #242a48;border-radius:12px">
          <table id="teamTable">
            <thead></thead>
            <tbody></tbody>
          </table>
        </div>
      </section>

      <section class="panel" id="myRequestsPanel">
        <h3>Minhas solicita√ß√µes de troca</h3>
        <div id="requestsList" class="list"></div>
      </section>

      <section class="panel adminOnly">
        <h3>Painel do Admin ‚Äî Aprovar trocas</h3>
        <div id="adminRequestsList" class="list"></div>
      </section>

      <section class="panel">
        <h3>Feriados</h3>
        <div class="grid3 adminOnly">
          <input type="date" id="holidayDate">
          <button class="btn" id="addHolidayBtn">‚ûï Adicionar</button>
          <button class="btn" id="resyncYearBtn">üîÅ Re-sync ano vis√≠vel</button>
        </div>
        <div id="holidayList" class="list" style="margin-top:.8rem"></div>
      </section>
    </div>
  </main>

  <!-- Modal -->
  <div id="modal"
    style="display:none;position:fixed;inset:0;background:rgba(0,0,0,.5);align-items:center;justify-content:center;z-index:50;">
    <div class="panel" style="width:min(680px,92vw);max-height:86vh;overflow:auto">
      <div class="split">
        <h3 id="modalTitle">Modal</h3>
        <button class="btn" id="closeModal">‚úñ</button>
      </div>
      <div id="modalContent"></div>
    </div>
  </div>

  <!-- Settings bottom sheet -->
  <div class="settings" id="settingsSheet">
    <div class="sheet">
      <div class="split" style="justify-content:space-between">
        <h3>Configura√ß√µes de Feriados (UF/Munic√≠pio & APIs)</h3>
        <button class="btn" id="closeSettings">Fechar</button>
      </div>
      <div class="grid3">
        <div>
          <div class="label">UF (estado)</div>
          <select id="ufSelect">
            <option value="SP" selected>SP ‚Äî S√£o Paulo</option>
            <option value="RJ">RJ ‚Äî Rio de Janeiro</option>
            <option value="MG">MG ‚Äî Minas Gerais</option>
            <option value="RS">RS ‚Äî Rio Grande do Sul</option>
            <option value="PR">PR ‚Äî Paran√°</option>
          </select>
        </div>
        <div>
          <div class="label">Munic√≠pio (IBGE)</div>
          <input id="ibgeCity" type="text" value="3550308" placeholder="ex.: 3550308 (S√£o Paulo)" />
        </div>
        <div>
          <div class="label">Ano alvo</div>
          <input id="settingsYear" type="number" min="2000" max="2100" />
        </div>
      </div>

      <div class="grid2" style="margin-top:.8rem">
        <div>
          <div class="label">Calendarific API Key (estado/UF)</div>
          <input id="calendarificKey" type="text" placeholder="opcional ‚Äî region=UF" />
        </div>
        <div>
          <div class="label">Invertexto Token (municipal)</div>
          <input id="invertextoToken" type="text" placeholder="opcional ‚Äî city=IBGE" />
        </div>
      </div>

      <div class="split" style="justify-content:flex-end;margin-top:1rem">
        <button class="btn" id="saveSettings">Salvar</button>
        <button class="btn primary" id="testSync">Testar sync agora</button>
      </div>
    </div>
  </div>

  <!-- Login -->
  <div id="loginOverlay">
    <div class="loginCard">
      <h3 style="margin-top:0">Entrar</h3>
      <div class="grid2">
        <div>
          <div class="label">Perfil</div>
          <select id="loginRole">
            <option value="admin">Admin</option>
            <option value="func" selected>Funcion√°rio</option>
          </select>
        </div>
        <div id="loginEmployeeWrap">
          <div class="label">Funcion√°rio</div>
          <select id="loginEmployee"></select>
        </div>
      </div>
      <div class="split" style="justify-content:flex-end;margin-top:1rem">
        <button class="btn primary" id="loginBtn">Entrar</button>
      </div>
      <div class="muted" style="font-size:.9rem;margin-top:.4rem">
        Funcion√°rio v√™ a escala e solicita trocas. Admin gerencia tudo.
      </div>
    </div>
  </div>

  <script type="module" defer src="./js/main.js"></script>
  <script>
    // Modal de legenda
    const openLegendBtn = document.getElementById('openLegendBtn');
    const legendModal = document.getElementById('legendModal');
    const closeLegendBtn = document.getElementById('closeLegendBtn');
    if (openLegendBtn && legendModal && closeLegendBtn) {
      openLegendBtn.onclick = () => legendModal.style.display = 'flex';
      closeLegendBtn.onclick = () => legendModal.style.display = 'none';
      legendModal.onclick = e => { if (e.target === legendModal) legendModal.style.display = 'none'; };
    }
  </script>
  <script>
    // Minimizar/expandir header para mobile (corrigido)
    document.addEventListener('DOMContentLoaded', function () {
      const header = document.getElementById('mainHeader');
      const controls = document.getElementById('headerControls');
      const toggleBtn = document.getElementById('toggleHeaderBtn');
      const iconPath = document.getElementById('headerToggleIconPath');
      let minimized = false;
      function updateHeader() {
        if (minimized) {
          header.classList.add('minimized');
          toggleBtn.setAttribute('aria-label', 'Expandir header');
          // seta para baixo
          iconPath.setAttribute('d', 'M6 9l5 5 5-5');
        } else {
          header.classList.remove('minimized');
          toggleBtn.setAttribute('aria-label', 'Minimizar header');
          // seta para cima
          iconPath.setAttribute('d', 'M6 13l5-5 5 5');
        }
      }
      toggleBtn.addEventListener('click', () => {
        minimized = !minimized;
        updateHeader();
      });
      // Mobile: inicia minimizado se tela pequena
      if (window.innerWidth < 600) {
        minimized = true;
        updateHeader();
      }
      window.addEventListener('resize', () => {
        if (window.innerWidth < 600 && !minimized) {
          minimized = true;
          updateHeader();
        } else if (window.innerWidth >= 600 && minimized) {
          minimized = false;
          updateHeader();
        }
      });
    });
  </script>
</body>

</html>